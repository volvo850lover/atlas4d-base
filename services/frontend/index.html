<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Atlas4D Base - Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        
        #header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        #header h1 { font-size: 1.5rem; }
        
        #stats {
            display: flex;
            gap: 2rem;
            font-size: 0.9rem;
        }
        
        .stat { text-align: center; }
        .stat-value { font-size: 1.5rem; font-weight: bold; }
        .stat-label { opacity: 0.8; }
        
        #map { height: calc(100vh - 120px); }
        
        #controls {
            background: #f5f5f5;
            padding: 0.5rem 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        button:hover { background: #5a6fd6; }
        button.active { background: #764ba2; }
        
        select, input {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        #status {
            margin-left: auto;
            font-size: 0.85rem;
            color: #666;
        }
        
        .leaflet-popup-content { min-width: 220px; }
        .popup-title { font-weight: bold; margin-bottom: 0.5rem; font-size: 1.1em; }
        .popup-row { display: flex; justify-content: space-between; margin: 0.25rem 0; }
        .popup-label { color: #666; }
        .popup-value { font-weight: 500; }
        .popup-section { margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee; }
        
        .legend {
            background: white;
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .legend h4 { margin-bottom: 8px; font-size: 0.9em; }
        .legend-item { display: flex; align-items: center; margin: 4px 0; font-size: 0.85em; }
        .legend-color { width: 14px; height: 14px; border-radius: 50%; margin-right: 8px; border: 1px solid #ccc; }
        
        .scenario-label { font-weight: 500; color: #333; }
    </style>
</head>
<body>
    <div id="header">
        <h1>üåê Atlas4D Base</h1>
        <div id="stats">
            <div class="stat">
                <div class="stat-value" id="obs-count">-</div>
                <div class="stat-label">Observations</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="anom-count">-</div>
                <div class="stat-label">Anomalies</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="sources-count">-</div>
                <div class="stat-label">Sources</div>
            </div>
        </div>
    </div>
    
    <div id="controls">
        <span class="scenario-label">Scenario:</span>
        <select id="scenario" onchange="changeScenario()">
            <option value="all">All Data</option>
            <option value="mobility">üöó Mobility</option>
            <option value="telecom">üì° Telecom</option>
        </select>
        
        <label>Hours: 
            <select id="hours">
                <option value="1">1h</option>
                <option value="6">6h</option>
                <option value="24" selected>24h</option>
                <option value="168">7 days</option>
            </select>
        </label>
        <button onclick="loadData()">üîÑ Refresh</button>
        <span id="status">Ready</span>
    </div>
    
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const API_BASE = '';
        let currentScenario = 'all';
        
        // Initialize map centered on Burgas
        const map = L.map('map').setView([42.5, 27.46], 11);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);
        
        // Layer groups
        const observationsLayer = L.layerGroup().addTo(map);
        const anomaliesLayer = L.layerGroup().addTo(map);
        
        // Color schemes for different scenarios
        const mobilityColors = {
            'vehicle': '#3498db',
            'sensor': '#2ecc71',
            'camera': '#e74c3c',
            'manual': '#9b59b6'
        };
        
        const telecomColors = {
            'olt': '#e74c3c',
            'switch': '#f39c12',
            'cpe': '#3498db',
            'traffic_metric': '#2ecc71'
        };
        
        const defaultColor = '#95a5a6';
        
        // Source type filters
        const mobilityTypes = ['vehicle', 'sensor', 'camera', 'manual'];
        const telecomTypes = ['olt', 'switch', 'cpe', 'traffic_metric'];
        
        // Legend control
        let legendControl = null;
        
        function updateLegend() {
            if (legendControl) {
                map.removeControl(legendControl);
            }
            
            legendControl = L.control({ position: 'bottomright' });
            legendControl.onAdd = function() {
                const div = L.DomUtil.create('div', 'legend');
                
                if (currentScenario === 'mobility') {
                    div.innerHTML = `
                        <h4>üöó Mobility</h4>
                        <div class="legend-item"><span class="legend-color" style="background:#3498db"></span> Vehicle</div>
                        <div class="legend-item"><span class="legend-color" style="background:#2ecc71"></span> Sensor</div>
                        <div class="legend-item"><span class="legend-color" style="background:#e74c3c"></span> Camera</div>
                        <div class="legend-item"><span class="legend-color" style="background:#9b59b6"></span> Manual</div>
                        <div class="legend-item"><span class="legend-color" style="background:#f39c12; border: 2px solid #c0392b"></span> Anomaly</div>
                    `;
                } else if (currentScenario === 'telecom') {
                    div.innerHTML = `
                        <h4>üì° Telecom</h4>
                        <div class="legend-item"><span class="legend-color" style="background:#e74c3c"></span> OLT</div>
                        <div class="legend-item"><span class="legend-color" style="background:#f39c12"></span> Switch</div>
                        <div class="legend-item"><span class="legend-color" style="background:#3498db"></span> CPE</div>
                        <div class="legend-item"><span class="legend-color" style="background:#2ecc71"></span> Traffic</div>
                        <div class="legend-item"><span class="legend-color" style="background:#f39c12; border: 2px solid #c0392b"></span> Anomaly</div>
                    `;
                } else {
                    div.innerHTML = `
                        <h4>All Sources</h4>
                        <div class="legend-item"><span class="legend-color" style="background:#3498db"></span> Vehicle/CPE</div>
                        <div class="legend-item"><span class="legend-color" style="background:#2ecc71"></span> Sensor/Traffic</div>
                        <div class="legend-item"><span class="legend-color" style="background:#e74c3c"></span> Camera/OLT</div>
                        <div class="legend-item"><span class="legend-color" style="background:#f39c12"></span> Switch</div>
                        <div class="legend-item"><span class="legend-color" style="background:#f39c12; border: 2px solid #c0392b"></span> Anomaly</div>
                    `;
                }
                return div;
            };
            legendControl.addTo(map);
        }
        
        function getColor(sourceType) {
            if (currentScenario === 'mobility') {
                return mobilityColors[sourceType] || defaultColor;
            } else if (currentScenario === 'telecom') {
                return telecomColors[sourceType] || defaultColor;
            } else {
                return mobilityColors[sourceType] || telecomColors[sourceType] || defaultColor;
            }
        }
        
        function getMarkerSize(sourceType) {
            // Larger markers for infrastructure nodes
            if (['olt', 'switch'].includes(sourceType)) return 10;
            if (sourceType === 'cpe') return 5;
            return 6;
        }
        
        function shouldShowType(sourceType) {
            if (currentScenario === 'all') return true;
            if (currentScenario === 'mobility') return mobilityTypes.includes(sourceType);
            if (currentScenario === 'telecom') return telecomTypes.includes(sourceType);
            return true;
        }
        
        function formatMetadata(props) {
            if (!props.metadata) return '';
            try {
                const meta = typeof props.metadata === 'string' ? JSON.parse(props.metadata) : props.metadata;
                let html = '<div class="popup-section">';
                
                // Telecom-specific fields
                if (meta.name) html += `<div class="popup-row"><span class="popup-label">Name:</span> <span class="popup-value">${meta.name}</span></div>`;
                if (meta.capacity_gbps) html += `<div class="popup-row"><span class="popup-label">Capacity:</span> <span class="popup-value">${meta.capacity_gbps} Gbps</span></div>`;
                if (meta.active_ports) html += `<div class="popup-row"><span class="popup-label">Active Ports:</span> <span class="popup-value">${meta.active_ports}</span></div>`;
                if (meta.rx_power_dbm) html += `<div class="popup-row"><span class="popup-label">RX Power:</span> <span class="popup-value">${meta.rx_power_dbm} dBm</span></div>`;
                if (meta.bandwidth_mbps) html += `<div class="popup-row"><span class="popup-label">Bandwidth:</span> <span class="popup-value">${meta.bandwidth_mbps} Mbps</span></div>`;
                if (meta.throughput_gbps) html += `<div class="popup-row"><span class="popup-label">Throughput:</span> <span class="popup-value">${meta.throughput_gbps} Gbps</span></div>`;
                if (meta.latency_ms) html += `<div class="popup-row"><span class="popup-label">Latency:</span> <span class="popup-value">${meta.latency_ms} ms</span></div>`;
                if (meta.packet_loss_pct) html += `<div class="popup-row"><span class="popup-label">Packet Loss:</span> <span class="popup-value">${(meta.packet_loss_pct * 100).toFixed(2)}%</span></div>`;
                
                html += '</div>';
                return html;
            } catch (e) {
                return '';
            }
        }
        
        function getTypeIcon(sourceType) {
            const icons = {
                'olt': 'üè¢',
                'switch': 'üîÄ',
                'cpe': 'üì¶',
                'traffic_metric': 'üìä',
                'vehicle': 'üöó',
                'sensor': 'üì°',
                'camera': 'üì∑',
                'manual': '‚úèÔ∏è'
            };
            return icons[sourceType] || 'üìç';
        }
        
        function changeScenario() {
            currentScenario = document.getElementById('scenario').value;
            updateLegend();
            loadData();
        }
        
        function setStatus(msg) {
            document.getElementById('status').textContent = msg;
        }
        
        async function loadStats() {
            try {
                const res = await fetch(`${API_BASE}/api/stats`);
                if (!res.ok) throw new Error('Stats unavailable');
                const data = await res.json();
                
                document.getElementById('obs-count').textContent = data.total_observations.toLocaleString();
                document.getElementById('anom-count').textContent = data.total_anomalies.toLocaleString();
                document.getElementById('sources-count').textContent = Object.keys(data.sources).length;
            } catch (e) {
                console.error('Stats error:', e);
            }
        }
        
        async function loadData() {
            const hours = document.getElementById('hours').value;
            setStatus('Loading...');
            
            try {
                // Load observations
                const obsRes = await fetch(`${API_BASE}/api/geojson/observations?hours=${hours}&limit=1000`);
                if (!obsRes.ok) throw new Error('Failed to load observations');
                const obsData = await obsRes.json();
                
                observationsLayer.clearLayers();
                let displayedCount = 0;
                
                obsData.features.forEach(feature => {
                    const coords = feature.geometry.coordinates;
                    const props = feature.properties;
                    
                    // Filter by scenario
                    if (!shouldShowType(props.source_type)) return;
                    
                    const color = getColor(props.source_type);
                    const radius = getMarkerSize(props.source_type);
                    
                    const marker = L.circleMarker([coords[1], coords[0]], {
                        radius: radius,
                        fillColor: color,
                        color: '#fff',
                        weight: 1,
                        opacity: 1,
                        fillOpacity: 0.8
                    });
                    
                    const icon = getTypeIcon(props.source_type);
                    marker.bindPopup(`
                        <div class="popup-title">${icon} ${props.source_type?.toUpperCase() || 'Unknown'}</div>
                        <div class="popup-row"><span class="popup-label">ID:</span> <span class="popup-value">#${props.id}</span></div>
                        <div class="popup-row"><span class="popup-label">Time:</span> <span class="popup-value">${props.time ? new Date(props.time).toLocaleString() : 'N/A'}</span></div>
                        ${props.speed_ms ? `<div class="popup-row"><span class="popup-label">Speed:</span> <span class="popup-value">${props.speed_ms.toFixed(1)} m/s</span></div>` : ''}
                        ${formatMetadata(props)}
                    `);
                    
                    observationsLayer.addLayer(marker);
                    displayedCount++;
                });
                
                // Load anomalies
                const anomRes = await fetch(`${API_BASE}/api/anomalies?hours=${hours}&limit=100`);
                if (anomRes.ok) {
                    const anomData = await anomRes.json();
                    
                    anomaliesLayer.clearLayers();
                    
                    anomData.forEach(anom => {
                        if (anom.lat && anom.lon) {
                            // Filter by scenario if needed
                            if (currentScenario === 'telecom' && !anom.metadata?.network_demo) return;
                            if (currentScenario === 'mobility' && anom.metadata?.network_demo) return;
                            
                            const marker = L.circleMarker([anom.lat, anom.lon], {
                                radius: 12,
                                fillColor: '#f39c12',
                                color: '#c0392b',
                                weight: 2,
                                opacity: 1,
                                fillOpacity: 0.9
                            });
                            
                            marker.bindPopup(`
                                <div class="popup-title">‚ö†Ô∏è ${anom.anomaly_type?.replace('_', ' ').toUpperCase()}</div>
                                <div class="popup-row"><span class="popup-label">Severity:</span> <span class="popup-value">${anom.severity}/5</span></div>
                                <div class="popup-row"><span class="popup-label">Score:</span> <span class="popup-value">${(anom.score * 100).toFixed(0)}%</span></div>
                                <div class="popup-row"><span class="popup-label">Detected:</span> <span class="popup-value">${new Date(anom.detected_at).toLocaleString()}</span></div>
                                ${anom.source_type ? `<div class="popup-row"><span class="popup-label">Source:</span> <span class="popup-value">${anom.source_type}</span></div>` : ''}
                            `);
                            
                            anomaliesLayer.addLayer(marker);
                        }
                    });
                }
                
                setStatus(`Loaded ${displayedCount} observations (${currentScenario})`);
                await loadStats();
                
            } catch (e) {
                console.error('Load error:', e);
                setStatus('Error: ' + e.message);
            }
        }
        
        // Initial setup
        updateLegend();
        loadData();
        
        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);
    </script>
</body>
</html>
